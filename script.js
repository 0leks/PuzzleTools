const OFFICIAL_WORD_LIST_LOWER = ['nook','rump','curs','reak','type','ores','with','gaps','slow','fuse','prep','jury','hems','mush','reed','scan','warm','gull','very','swap','tufa','laze','gala','burs','twin','dune','wail','loan','seta','aver','dere','glut','true','wave','skim','zees','hics','mica','whip','deva','hate','vear','aims','saki','core','cant','cook','buzz','loin','pica','hunt','rids','ices','wary','bald','sign','shop','grow','safe','gust','tuft','dhow','mice','teth','whir','yeld','loop','noon','magi','stir','fury','palp','atom','sext','lard','soil','cent','teal','duct','cult','cash','mink','eker','sine','boom','alto','work','bent','jade','buck','ward','sole','cams','germ','acyl','text','teen','open','sham','ever','yawn','eyes','ewes','dons','sang','user','eons','dare','womb','bogs','yeas','goes','wade','lisp','albs','barf','oink','ally','rear','twit','ride','sear','read','sirs','suer','rial','lops','abut','earl','moos','cads','cool','guys','lust','psis','wont','mesa','feds','tzar','clay','lank','etas','sore','lens','menu','food','pray','nags','hoot','exon','jogs','oafs','weal','punt','ants','list','tofu','dint','lept','ante','bris','logs','nuns','unit','peer','pang','nape','pull','turn','mane','ales','suck','harm','spit','arts','damp','ower','fend','deet','webs','jeep','term','heck','pawn','wren','awns','fink','arks','curl','butt','puff','face','murk','woke','aryl','ogre','hums','olea','rant','pots','laud','norm','sent','rust','fans','puke','resh','muck','fins','part','spat','wile','lads','stow','flaw','saga','clot','leas','woof','coat','derm','dome','tens','matt','mays','coot','josh','vibe','subs','kill','tilt','writ','bump','orbs','know','nits','tear','gain','dogs','beam','boon','doff','hubs','pupa','balk','pros','kelp','ware','malt','tall','ploy','gimp','bobs','dozy','jowl','rags','foam','eves','barn','huhs','card','loot','seem','coin','bean','barm','pane','yowe','cosy','peso','bind','limy','stat','alps','mask','pens','teem','aids','yens','flan','drum','gigs','nuke','hint','peas','curd','math','veto','sits','mere','even','yaup','aped','tact','oleo','mums','brow','gobs','bays','mama','pony','jail','coal','raid','sets','mail','rand','loch','sawn','muff','bran','gong','curt','poet','gall','gulp','yelk','clan','bats','faze','ails','clog','calm','tiff','plug','tike','kind','tops','yuan','ilea','slay','lode','jell','fads','yill','fold','mast','pure','bots','runt','feed','hind','load','rays','juke','bade','kits','knee','pouf','ooid','dado','nibs','town','beth','stub','exit','urea','moat','awny','swan','wore','june','gees','fort','lead','grin','apes','suet','pili','lawn','gyre','soft','rift','forb','tuck','numb','salt','land','omit','keen','nets','dorm','thee','midi','paws','glia','pity','aged','doxx','mace','sell','plow','late','burp','gout','head','lots','oxea','crew','acid','test','leek','bust','grub','owes','tuba','scab','noun','slug','elms','wolf','dust','love','sone','hoax','calf','tuna','dray','were','gyps','dolt','solo','pion','pita','hung','draw','boys','rugs','rots','mine','shew','vote','sins','rule','fair','pool','pain','vole','sags','site','jobs','dues','hats','qadi','kats','hued','lope','hobo','limb','cave','loud','shoe','mule','save','same','clod','nail','cord','dunk','lute','lilt','plan','soot','fobs','luck','mild','soak','zoon','wifi','prow','coup','amps','hits','herd','kept','root','haze','cops','reel','grit','lean','pyre','dawn','mull','swiz','wipe','cock','moot','sera','loaf','yelm','gaga','hulk','poem','yews','howl','leap','lira','dive','saws','hues','edit','blur','sewn','rive','glue','spin','hope','wale','told','dorr','vase','ruse','thin','cobs','lore','zyme','memo','ting','nope','demy','oozy','rise','seer','rice','gins','tune','stab','ills','trek','fork','plus','pock','keel','punk','thud','goal','hams','bunk','ears','bath','agin','stay','diet','pint','hays','worn','wing','kids','ooze','funk','quid','icky','look','nude','boat','mugs','bark','hall','lump','jots','just','mead','yule','quay','haws','chum','garb','swag','zips','brim','city','leak','conk','cuts','warn','tack','tier','oats','cage','fine','drub','ripe','rife','bilk','doth','levs','hype','here','wort','flap','spam','zero','mist','tins','stem','yald','caws','blah','real','polo','tees','idea','debt','yips','snog','hose','pegs','pups','iamb','rate','slab','desk','yoga','hair','deed','flue','ones','fare','body','yolk','seek','rapt','buns','vatu','maze','tons','dole','paps','goof','span','woes','kook','tray','pomp','nick','door','ajar','zags','hypo','oars','fuze','foci','left','goat','blog','joke','keep','fall','rood','camp','snow','zest','rank','felt','bury','maps','code','than','foil','plod','coif','dens','axis','foot','sage','best','lugs','brew','ergo','peek','demo','fund','porn','cost','mews','skid','sick','tizz','loon','brie','paid','ruin','sots','mils','zaps','size','pigs','sill','dire','pair','goop','date','scry','duff','kava','smog','tell','wean','hilt','silk','shut','eery','alum','pave','ping','hour','gums','dupe','mile','uvea','exes','back','swig','rock','chic','foes','quad','chap','pied','navy','mint','deaf','gell','what','good','lose','toot','born','odds','spar','snip','clef','naut','dyad','bull','bask','fats','sway','hunk','kilt','yawl','fool','flee','lost','posy','eras','seas','cite','chip','each','stew','oven','acre','hash','acme','ukes','pore','edgy','swam','case','berk','scat','heat','scud','deck','eeks','helm','doxy','jive','jazz','smut','lamb','view','slap','wait','shot','hike','lane','sump','yows','lily','gait','poke','toro','dart','airs','deer','luge','bias','sacs','busy','wasp','yins','boos','cede','cane','bene','silo','sums','beep','bets','ream','your','cubs','vain','jars','boas','snag','nobs','dram','owns','twig','hard','pews','flop','rami','adds','gnat','byes','jabs','anon','glib','sing','dyed','amid','half','welt','rite','deep','hiss','axle','kina','bios','step','taxa','dads','else','pits','fits','ruff','lobe','tile','lamp','culm','keys','bolt','wham','gill','trio','dams','peal','push','birr','yagi','none','gnar','wand','pelt','taps','yack','null','taxi','quin','mood','minx','bowl','rove','buff','fogs','moor','slop','coax','dual','mash','rime','meme','keps','duty','team','puce','life','drib','sulk','blob','cull','fees','ropy','oily','lock','bows','rein','quiz','boor','skis','dibs','sour','duly','daze','find','snub','yurt','sews','rout','when','rode','coil','cape','swat','caps','trod','bout','bird','dung','cope','bite','give','sure','awed','deal','tums','hoes','bane','cons','flub','font','czar','cask','eggy','maim','fume','less','corm','claw','waxy','many','hoar','wrap','tool','huts','weak','nand','chiv','fret','ours','task','main','pate','mats','jugs','iron','crap','came','racy','wove','call','shim','romp','gags','ache','lone','xray','gyne','coys','high','tugs','loci','fowl','cell','acts','bred','book','trim','poor','duds','dews','vets','clue','keek','bang','wane','mite','foul','whup','weld','posh','gnaw','roll','bell','held','mini','loom','bone','snot','cast','deem','wish','vine','sass','flat','phis','thus','umps','jigs','fops','yard','puck','show','pass','kale','bush','crab','putt','trap','drug','troy','gild','pets','wets','sunk','prod','tarn','tare','lace','drip','brag','begs','fake','hogs','rips','folk','bole','dees','ages','vats','swab','ashy','ends','cans','lack','nuts','toke','dies','vice','boxy','jock','sues','owls','agar','verb','zeal','boss','musk','mens','dump','bank','swop','offs','poll','tote','mean','eels','hoop','lids','sand','hive','pest','ouch','then','dank','dear','wise','tout','prim','irid','bulk','ires','flog','cusp','luff','lear','jibe','hers','zoom','disk','airy','zerk','does','gape','slit','host','rack','dyer','peat','send','awls','pats','vend','ahem','roes','soli','jets','shmo','prey','haps','bins','crag','fizz','will','lark','doge','ands','bile','rind','hops','wadi','hide','bleb','mass','maid','walk','home','more','whiz','rake','nils','molt','dubs','like','cows','phub','loss','zein','fern','jink','vang','rick','bops','knew','lacy','pram','spry','belt','gasp','sued','slum','made','aces','dice','flag','axon','tusk','celt','cork','rile','pope','mars','sods','seat','pout','nose','peel','nosy','bids','seme','legs','levy','taro','icer','raze','cuff','rave','cyma','pent','yang','cyst','vale','onyx','chat','yods','gyms','such','repo','ahas','sail','hasp','vent','comb','scar','oops','tint','pall','beta','hugs','lair','razz','buys','port','boil','bale','pine','cold','mate','wilt','oryx','bunt','wind','seal','firs','lier','brat','clap','jinx','fray','tome','ways','pour','lout','mend','fore','pooh','pace','come','gist','wiry','riot','vans','gene','sire','gals','hire','copy','guts','whey','year','crow','feet','akin','cozy','loam','baud','lest','bake','skit','emit','cart','surf','gabs','yams','side','tags','tail','dean','yaps','cogs','lobs','gone','east','lent','lame','fish','zine','omen','flux','eats','isle','kink','wick','prop','snit','busk','lube','moth','whop','drop','doty','nice','wins','yean','wake','delf','shun','guck','heed','brin','form','blot','beds','bray','lure','zhos','vara','fogy','brux','eave','iris','lien','awes','bare','mark','jeli','fade','flay','bags','burl','bonk','rune','purr','hook','lake','both','jays','gate','rote','brad','vita','gaze','meal','raps','robs','vest','sitz','afar','slid','lint','jerk','dojo','vied','snap','rent','pipe','tams','reap','wash','swim','woad','redo','duke','stag','pear','uses','tram','word','goon','jaws','flit','wend','rily','hews','post','coak','whoa','lave','wool','hang','fell','vary','nigh','taut','serf','bail','sard','that','jump','lies','deft','egos','slur','dyes','yogi','wavy','trip','axel','dene','husk','gyro','jags','tale','sort','pail','loft','next','skin','blow','apex','heap','hero','pars','newt','roan','java','fast','pelf','dzos','alms','tore','kegs','beat','fire','effs','spud','dreg','buts','vile','barb','zone','cabs','coda','hens','waft','wimp','flip','chef','robe','bait','help','sows','sled','fohs','muse','undo','wauk','reds','girl','gnus','fozy','arcs','inks','furl','ties','bitt','lirk','neon','hill','dude','milk','neck','dead','aced','doll','yeah','ditz','aper','tone','sexy','chew','lain','cafe','tamp','lord','joys','vial','emir','pack','crud','mime','rute','bled','octo','ired','lush','tend','yare','dewy','mesh','idly','rats','tips','naps','axes','trot','pies','toad','kips','sigh','fumy','died','doze','oral','pogo','bawd','cram','glad','must','eely','pleb','dull','jeer','reek','thou','zigs','some','soys','logo','wife','hack','talk','deny','arid','anew','unto','hots','yaws','umbo','wags','flex','stud','coed','heth','fave','burr','zens','nerd','weir','peak','anal','till','tine','rill','star','vows','dell','wisp','hath','boot','rams','mill','went','club','lion','file','bond','jest','leer','scam','coho','hump','free','fame','race','goos','spay','laid','join','spot','yaff','bras','pare','gels','fang','huge','sols','bill','bums','ziti','lurk','tarp','pick','plop','nock','laps','male','over','cyme','bike','pink','shiv','lows','chug','raft','lift','chop','long','boar','horo','ions','bony','jute','miff','mess','nave','rigs','yird','tabu','soar','hula','lede','away','vees','moan','dock','have','ball','oxen','gang','lime','hazy','maul','sari','mods','gawp','tidy','myth','knob','oath','cube','risk','knit','darn','fill','ilka','coma','jivy','sips','dark','mold','arch','drag','rook','hark','sped','lieu','goth','tick','soup','base','kyak','deil','fate','lull','ribs','nabs','wons','fear','qats','zonk','rosy','shah','blab','chin','make','tsar','feud','chow','shed','eggs','tuff','oust','wist','guns','inns','wads','oxes','blip','lice','rows','news','sack','thaw','wire','pith','duel','berm','shoo','hear','wide','ruts','irks','char','cove','curb','runs','teas','juts','mart','geld','ambo','note','soya','bawl','awry','yerk','vies','cots','tong','rose','pant','park','move','fuel','sank','honk','zeps','yuks','gent','wall','furs','tars','pond','gawk','clag','weds','papa','limn','time','lari','iced','mode','whim','zany','ergs','duet','pads','cups','this','dusk','jams','slip','meat','ells','gage','dose','dove','oohs','ayin','five','revs','dodo','sold','glen','need','tubs','glow','vape','gets','rums','wars','moho','boll','kuna','corn','avid','past','mown','oils','skew','seam','siku','refs','rest','zarf','bans','pose','yaud','sift','dabs','lady','drew','hick','bore','earn','laws','tabs','tart','hoed','poky','self','pods','chub','abet','hole','cuds','path','been','rasp','beef','cole','data','fuss','peck','teed','baht','area','rims','soms','wyes','phiz','fora','hewn','slat','alas','roil','sikh','tide','line','gale','pimp','chad','rubs','gods','rods','says','yogh','golf','ides','lick','veal','halt','dork','jack','oval','goby','atop','babe','rink','dial','duos','perk','tied','yipe','grew','film','mind','bars','hips','mope','kyat','mutt','soap','crop','halo','army','bits','digs','them','cloy','flox','imps','huff','cwms','eddy','wigs','sock','marl','tans','nips','band','well','rush','tipi','used','cyan','only','visa','sect','hoer','fled','zati','grey','cure','taka','gird','dims','poop','rope','tyke','lash','dent','limp','sobs','veer','mock','mitt','lung','dope','slot','yelp','styx','gave','west','byte','doom','mops','crib','apps','ekes','four','tern','wine','eyed','soul','pole','whet','wood','full','asps','tire','tows','inch','bold','cees','want','pork','dine','sung','game','toes','rues','cars','loll','from','voes','arty','silt','hold','slam','woks','arms','mare','mara','defy','soon','lass','deme','easy','stop','flew','wack','clad','hand','pump','pale','weep','gaol','heel','beau','daft','loti','take','yuga','nest','coop','zinc','cued','dirt','deys','dote','blue','yett','nine','whom','rich','baby','feta','bibs','miss','goer','jolt','disc','baas','tiny','much','most','mute','toss','palm','roam','neat','live','bass','prom','ring','king','deli','quit','lips','room','sees','zeta','kern','muon','seed','node','geek','tort','into','blew','hail','ding','loco','play','vise','buhr','kiss','rail','yaks','suit','puma','kays','pubs','gift','lets','ramp','cats','void','bens','tree','slaw','nays','wear','opal','jilt','gash','waif','acne','faux','holy','faun','foxy','dots','smit','yell','hows','farm','yoni','dame','mans','sale','junk','wart','lory','item','dash','lags','plum','amyl','slog','waly','lied','perm','ruby','tank','eros','aven','buhl','haul','onus','heal','dill','leaf','puny','torn','pert','slob','spun','gram','pill','taus','spas','wows','song','rare','sagy','feel','glob','cute','wink','lava','puns','knar','terp','puts','lees','yirr','warp','yesk','yuck','fibs','opts','pays','onto','foal','tics','shin','leks','rude','owed','hell','typo','sere','achy','liar','neap','guff','yoke','clip','rely','cowl','horn','wits','jean','peps','firm','bash','sofa','dish','loos','xyst','raws','itch','scot','aide','ease','crux','colt','mayo','mire','hull','poxy','bode','jamb','aunt','gulf','pins','knur','kata','hoof','peon','pike','snob','axed','drey','sloe','beak','gaff','fuzz','down','gory','gunk','moss','fond','road','lays','wily','care','skip','scum','wawl','bear','teak','toga','bulb','saps','clop','rage','goad','pius','kine','hood','quip','grid','thug','ashs','tape','ibis','worm','snug','yeuk','weed','fact','ilks','fail','toll','lite','amen','thru','bees','meet','toms','ogle','nods','unix','vane','cere','owly','hags','rang','leus','waul','dins','woos','sake','took','bend','lewd','taco','buoy','edge','watt','scuz','girn','stun','stye','dumb','mole','knot','veil','beet','rued','toil','daub','tech','dyne','sown','rash','aloe','zing','last','bard','melt','vugs','alef','meld','yore','buds','lyre','bide','riel','aahs','vast','tomb','toff','gold','auto','coos','hare','hawk','outs','ewer','glum','eked','idle','feat','glee','balm','pans','jali','pact','frog','ween','they','mach','tent','sash','pops','cone','tron','done','qaid','carp','suns','asks','etch','gems','tube','fain','glug','dors','diva','dele','lire','lade','gear','reef','flab','dips','sink','pier','sate','vamp','icon','odes','grab','tala','riff','inky','lend','maws','mage','yowl','mows','cedi','heir','skep','yodh','dime','wept','talc','yank','fuff','toed','tyro','july','oaks','gilt','gosh','sane','bevy','wive','floe','week','flea','wage','flax','hone','fens','grim','fist','pugs','vein','rend','hush','gush','gore','zits','smug','herb','pips','suqs','plot','hurl','roof','rung','mobs','cake','bomb','name','tour','yarn','days','figs','cuss','gown','ably','doer','meek','whew','soda','tame','peep','hurt','flow','link','page','yeti','rain','grip','roar','sons','volt','anus','monk','bloc','slim','zeds','pals','ayes','labs','burn','spur','role','limo','pend','cues','harp','also','pled','toys','cods','zizz','said','blat','elks','ares','kick','nubs','bugs','kiln','plea','seep','cola','lazy','pulp','near','aril','swum','kite','chis','roue','rhos','wild','gray','sumo','fawn','moon','slew','ynal','turf','beer','able','aria','tots','bead','pile','yond','damn','drab','heme','duck','calx','pepo','mall','seen','moms','viol','rape','ship','suds','yawp','sops','zoos'];
const OFFICIAL_WORD_LIST = OFFICIAL_WORD_LIST_LOWER.map(word => word.toUpperCase());

function compareWords(w1, w2) {
    let diff = 0
    for (let i = 0; i < w1.length && i < w2.length; i++)
    {
        if (w1.charAt(i) != w2.charAt(i)) {
            diff += 1;
        }
    }
    diff += Math.abs(w1.length - w2.length);
    return diff
}

function preprocessWords(words) {
    let nodes = {};
    for (let index1 = 0; index1 < words.length; index1++) {
        nodes[words[index1]] = [];
    }
    for (let index1 = 0; index1 < words.length - 1; index1++) {
        for (let index2 = index1 + 1; index2 < words.length; index2++) {
            if (compareWords(words[index1], words[index2]) == 1) {
                nodes[words[index1]].push(words[index2]);
                nodes[words[index2]].push(words[index1]);
            }
        }
    }
    return nodes;
}

const MIN_WIDTH = 500;
const MIN_HEIGHT = 500;

const NODE_WIDTH = 40;
const NODE_HEIGHT = 20;

const FIXED_COLOR = "#0F0"
const REGULAR_COLOR = "#5AF"
const NEIGHBOR_COLOR = "#AAA"

const WORD_GRAPH = preprocessWords(OFFICIAL_WORD_LIST);
const SVG =  d3.select('#sim2svg');

let svgSize = {width: 100, height: 100}
const force = d3.layout.force();
force.linkDistance(linkDistance);
force.linkStrength(linkStrength)
force.charge(linkCharge)
force.chargeDistance(300)
force.gravity(.001)
force.on('tick.end', updatePositions);

let nodes = force.nodes();
let links = force.links();
let linkSelection = SVG.select(".links").selectAll('.link');
let nodeSelection = SVG.select(".nodes").selectAll('.node');

let inputWordList = [];

let settings = {
    charge: -40,
    linkDistance: 100,
    linkStrength: .8
};
function updateSettings() {
    settings.charge = parseInt(document.getElementById("charge").value);
    settings.linkDistance = parseInt(document.getElementById("linkDistance").value);
    settings.linkStrength = parseFloat(document.getElementById("linkStrength").value);
    force.resume();
}

updateSettings();

function linkStrength(link) {
    if (link.source.color == NEIGHBOR_COLOR && link.target.color == NEIGHBOR_COLOR) {
        return settings.linkStrength * .01 / .8;
    }
    else if(link.source.color == NEIGHBOR_COLOR || link.target.color == NEIGHBOR_COLOR) {
        return settings.linkStrength * .09 / .8;
    }
    return settings.linkStrength;
}

function linkDistance(link) {
    if (link.source.color == NEIGHBOR_COLOR && link.target.color == NEIGHBOR_COLOR) {
        return settings.linkDistance * .2;
    }
    else if(link.source.color == NEIGHBOR_COLOR || link.target.color == NEIGHBOR_COLOR) {
        return settings.linkDistance * .5;
    }
    return settings.linkDistance;
}

function linkCharge(node) {
    if (node.color == NEIGHBOR_COLOR) {
        return settings.charge / 5;
    }
    else {
        return settings.charge;
    }
}

// List of nodes
// let nodes = [];
// Dictionary of word -> node
let nodesDict = {};
let nodeIDCounter = 0;
// let links = [];
let linksDict = {};

function updateSize() {
    svgSize = document.getElementById("sim2svg").getBoundingClientRect();
    force.size([svgSize.width, svgSize.height])
}
addEventListener('resize', (event) => {updateSize()});
new ResizeObserver(updateSize);
updateSize();

function doesNodeExist(wordtoadd) {
    return wordtoadd in nodesDict;
}

function addNode(wordtoadd) {
    if (doesNodeExist(wordtoadd)) {
        return nodesDict[wordtoadd];
    }
    let newnode = {
        id: nodeIDCounter++, 
        word: wordtoadd, 
        x:svgSize.width/2 + nodes.length, 
        y: svgSize.height/2 + nodes.length%3 - 1, 
        color: NEIGHBOR_COLOR};
    nodesDict[wordtoadd] = newnode;
    nodes.push(newnode);
    return newnode;
}

function getNodeByID(id) {
    for (let n of nodes) {
        if (n.id == id) {
            return n;
        }
    }
    return null;
}

function isNeighborOfImportantNodeThatsNotMe(node, me) {
    if (node.id in linksDict) {
        for (let neighbor of linksDict[node.id]) {
            if (neighbor == me.id) {
                continue;
            }
            let neighborNode = getNodeByID(neighbor);
            if (neighborNode.color != NEIGHBOR_COLOR) {
                return true;
            }
        }
    }
    return false;
}

function addNeighborLinks(node, onlyToImportant = false) {
    for (let neighbor of OFFICIAL_WORD_LIST) {
        if (compareWords(node.word, neighbor) == 1) {
            if (doesNodeExist(neighbor)) {
                let neighbornode = addNode(neighbor);
                // already linked
                if (node.id in linksDict && linksDict[node.id].has(neighbornode)) {
                    continue;
                }
                if (onlyToImportant && neighbornode.color == NEIGHBOR_COLOR) {
                    continue;
                }
                if (!(node.id in linksDict)) {
                    linksDict[node.id] = new Set();
                }
                linksDict[node.id].add(neighbornode);
                if (!(neighbornode.id in linksDict)) {
                    linksDict[neighbornode.id] = new Set();
                }
                linksDict[neighbornode.id].add(node);

                if (node.id < neighbornode.id) {
                    links.push({source: node, target: neighbornode});
                }
                else {
                    links.push({source: neighbornode, target: node});
                }
            }
        }
    }
}

function possiblyDeleteNode(node) {
    let numRemainingLinks = 0;
    if (node.id in linksDict) {
        // for (let secondLink of linksDict[node.id]) {
        //     removeNeighborLinks(secondLink, false);
        // }
        numRemainingLinks += linksDict[node.id].size;
    }
    if (numRemainingLinks == 0) {
        delete nodesDict[node.word]
        console.log('deleting node ' + node.word);
        nodes = nodes.filter(n => n != node);
        force.nodes(nodes);
    }
}

function removeNeighborLinks(node, recurse=true) {
    links = links.filter(link => {
        let thisNode = null;
        let otherNode = null;
        if (link.source.id == node.id) {
            thisNode = link.source;
            otherNode = link.target;
        }
        else if (link.target.id == node.id) {
            thisNode = link.target;
            otherNode = link.source;
        }
        if (thisNode && otherNode) {
            console.log('observing ' + otherNode.word);
            if (otherNode.color == NEIGHBOR_COLOR) {
                linksDict[otherNode.id].delete(thisNode);
                linksDict[thisNode.id].delete(otherNode);
                if (recurse) {
                    possiblyDeleteNode(otherNode);
                }
                return false;
            }
        }
        return true;
    });
    force.links(links);
}

function addWord(wordtoadd, includeNeighbors) {
    console.log("adding word " + wordtoadd);
    let newnode = addNode(wordtoadd);
    if (newnode.fixed) {
        newnode.color = FIXED_COLOR;
    }
    console.log(newnode);

    if (includeNeighbors) {
        for (let neighborWord of WORD_GRAPH[wordtoadd]) {
            let neighborNode = addNode(neighborWord);
            addNeighborLinks(neighborNode, true);
        }
    }
    addNeighborLinks(newnode);

    // SVG.selectAll("*").remove();
    // force.nodes(nodes).links(links);
    
    // resetSim();
    return newnode;
}

function updateNodeColor(node) {
    if (node.fixed) {
        node.color = FIXED_COLOR;
    }
    else if (inputWordList.includes(node.word)) {
        node.color = REGULAR_COLOR;
    }
    else {
        node.color = NEIGHBOR_COLOR;
    }
}

function toggleWord(wordtoadd) {
    let node = addNode(wordtoadd);

    if (node.showNeighbors) {
        node.showNeighbors = false;
        removeNeighborLinks(node);
    }
    else {
        node.showNeighbors = true;
        addWord(wordtoadd, true);
    }
    updateNodeColor(node);
    resetSim();
}

function loadWordsFromStorage() {
    let words = localStorage.getItem('words');
    if (!words) {
        words = ['star', 'trek'];
    }
    else {
        words = words.split(',');
    }
    WORDS_TEXT_AREA.value = words.join(' ');
    return words;
}

const WORDS_TEXT_AREA = document.getElementById("wordstoadd");
loadWordsFromStorage();

function getWords() {
    WORDS_TEXT_AREA.value = WORDS_TEXT_AREA.value.toUpperCase()
    inputWordList = WORDS_TEXT_AREA.value.split(/[,\s]+/).filter(word => word.length > 0);
    localStorage.setItem('words', inputWordList);
    return inputWordList;
}

let firstAddition = true;
function addWordFormSubmit() {
    for (let word of getWords()) {
        let newnode = addWord(word, false);
        newnode.color = REGULAR_COLOR;
    }
    if (firstAddition) {
        // force.nodes(nodes).links(links);
        firstAddition = false;
    }
    resetSim();
}

let nodegroups = null;
let nodecircles = null;
let linkdata = null;
function updatePositions() {
    nodeSelection
        .attr("transform", d => {
            d.x = Math.max(NODE_WIDTH/2, Math.min(svgSize.width - NODE_WIDTH/2, d.x));
            d.y = Math.max(NODE_HEIGHT/2, Math.min(svgSize.height - NODE_HEIGHT/2, d.y));
            return "translate(" + d.x + "," + d.y + ")";
        });

    nodeSelection.select("rect")
            .attr('fill', d => d.color)
            .attr('stroke', d => {
                return d.hovered ? '#000' : (d.showNeighbors ? FIXED_COLOR : d.color)
            })

    linkSelection.attr('x1', function(d) { return d.source.x; })
        .attr('y1', function(d) { return d.source.y; })
        .attr('x2', function(d) { return d.target.x; })
        .attr('y2', function(d) { return d.target.y; })
        .attr('stroke', d => {
            if (d.source.color == NEIGHBOR_COLOR || d.target.color == NEIGHBOR_COLOR) {
                return NEIGHBOR_COLOR;
            }
            else if (d.source.color == REGULAR_COLOR || d.target.color == REGULAR_COLOR) {
                return REGULAR_COLOR
            }
            else {
                return FIXED_COLOR;
            }
        });
}

function resetSim() {
    let drag = force.drag()
            .on("dragstart", dragstart)
            .on("dragend", dragend)
            .on("drag", dragged);

    linkSelection = linkSelection.data(links, d => d.source.id + '-' + d.target.id);
    linkSelection.enter()
            .insert('line')
            .attr('class', 'link');
    
    linkSelection.exit().remove();

    
    nodeSelection = nodeSelection.data(nodes, d => d.id);

    nodegroups = nodeSelection.enter()
            .insert('g')
            .attr('class', 'node')
            .call(drag)
            .on('contextmenu', rightclick)
            .on('mouseover', mouseover)
            .on("mouseout", mouseout)
            .on('dblclick', dblclick)
            .on('click', click)
    
    nodegroups.append('text')
            .attr('class', 'nodetext')
            .attr("dominant-baseline", "central")
            .text(d => d.word)
    
    nodegroups.append('rect')
            .attr('class', 'nodeRect')
            .attr('x', -NODE_WIDTH/2)
            .attr('y', -NODE_HEIGHT/2)
            .attr('width', NODE_WIDTH)
            .attr('height', NODE_HEIGHT)

    nodeSelection.exit()
            // .transition().duration(2000).attr("x", 0)
            .remove();

    force.start();
}

function mouseover(d) {
    d.hovered = true;
    updatePositions();
    // d3.select(this).select("rect").attr("stroke", "#000")
}
function mouseout(d) {
    delete d.hovered;
    updatePositions();
    // d.strokeColor = "#F00";
    // d3.select(this).select("rect").attr("stroke", null)
}
function rightclick(d) {
    d3.event.preventDefault();
    d.fixed = !d.fixed;
    updateNodeColor(d);
    updatePositions();
}

function dblclick(d) {
    toggleWord(d.word);
}

function click() {
    console.log('click');
}

function dragstart() {
    console.log('dragstart');
}

function dragend() {
    console.log('dragend');
}
function dragstart2() {
    console.log('dragstart2');
}
function dragged() {
    // console.log('dragged');
}

function stopButton() {
    force.stop();
}

function resumeButton() {
    force.resume();
}
